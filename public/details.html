<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalles de la Película</title>
    <link rel="stylesheet" href="./css/details.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <a href="index.html">Volver al Inicio</a>
        </nav>
    </header>

    <main class="movie-details">
        <div class="details-container">
            <div class="details-content">
                <img id="movie-banner" src="" alt="Banner de la película">
                <div class="info">
                    <div class="details-row"> <!-- Contenedor flex para acciones y descripción -->
                        <div class="actions">
                            <a id="watch-button" class="button">Ver en [Nombre del Servicio]</a>
                            <a id="edit-button" class="button">Editar</a>
                            <button id="delete-button" class="button">Eliminar</button>
                        </div>
                        
                        <div class="movie-title-description">
                            <h3 id="movie-title"></h3>
                            <p id="movie-description"><strong></strong> <span id="movie-contenido"></span></p>
                        </div>
    
                        <!-- Mover movie-meta aquí, al lado de movie-title-description -->
                        <div class="movie-meta row">
                            <div class="col">
                                <strong>Categoría: </strong> <span id="movie-categoria"></span>
                            </div>
                            <div class="col">
                                <strong>Año: </strong> <span id="movie-anio"></span>
                            </div>
                            <div class="col">
                                <strong>Género: </strong> <span id="movie-genero"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2024 Clase de Programación Web. Todos los derechos reservados.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const movieId = getMovieIdFromUrl(); // Obtener el ID de la película de la URL
            loadMovieDetails(movieId); // Cargar detalles de la película

            document.getElementById('edit-button').addEventListener('click', () => {
                window.location.href = `edit.html?id=${movieId}`; // Redirigir a la página de edición
            });

            document.getElementById('delete-button').addEventListener('click', () => {
                deleteMovie(movieId); // Función para eliminar la película
            });
        });

        function getMovieIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id'); // Obtener el ID de la película de la URL
        }
        async function loadMovieDetails(id) {
            try {
                const response = await fetch(`http://localhost:8080/api/peliculas/${id}`);
                if (!response.ok) {
                    throw new Error('Error al cargar los detalles de la película');
                }
                const pelicula = await response.json(); // Obtener los detalles de la película

                // Asignar los valores a los elementos HTML
                document.getElementById('movie-title').innerText = pelicula.titulo;
                document.getElementById('movie-contenido').innerText = pelicula.contenido;
                document.getElementById('movie-categoria').innerText = pelicula.categoria;
                document.getElementById('movie-anio').innerText = pelicula.anio;
                document.getElementById('movie-genero').innerText = pelicula.genero;
                document.getElementById('movie-banner').src = pelicula.bannerUrl; // Asignar URL del banner

                // Establecer la URL del botón "Ver en"
                const watchButton = document.getElementById('watch-button');

                if (pelicula.watchUrl) {
                    watchButton.href = pelicula.watchUrl; // Establecer la URL para ver la película
                    const serviceName = getServiceNameFromUrl(pelicula.watchUrl);
                    watchButton.innerText = `Ver en ${serviceName}`; // Actualizar el texto del botón
                } else {
                    watchButton.href = '#'; // Deshabilitar el enlace
                    watchButton.innerText = 'No disponible'; // Texto alternativo
                }

            } catch (error) {
                console.error('Error al cargar los detalles de la película:', error);
            }
        }
        // Función para obtener el nombre del servicio a partir del URL
        function getServiceNameFromUrl(url) {
                const services = {
                'max.com': 'Max',
                'netflix.com': 'Netflix',
                'hulu.com': 'Hulu',
                'disneyplus.com': 'Disney+',
                'primevideo.com': 'Prime Video',
                'apple.com': 'Apple TV+',
                'tv.apple.com': 'Apple TV+',
                'appletv.com': 'Apple TV+',
                'hbo.com': 'HBO',
                'youtube.com': 'YouTube',
                'peacocktv.com': 'Peacock',
                'paramountplus.com': 'Paramount+',
                'starz.com': 'Starz',
                'showtime.com': 'Showtime',
                'crunchyroll.com': 'Crunchyroll',
                'funimation.com': 'Funimation',
                'tubitv.com': 'TubiTV',
                'vudu.com': 'Vudu', 
                'fandango.com': 'FandangoNOW',
                'sling.com': 'Sling TV',
                'roku.com': 'Roku', 
                'pluto.tv': 'Pluto TV',
                'crackle.com': 'Crackle', 
                'mubi.com': 'Mubi', 
                'hoopladigital.com': 'Hoopla',
                // Agregar más servicios según sea necesario
            };

            const urlObject = new URL(url);
            const hostname = urlObject.hostname.replace('www.', ''); // Obtener el hostname

            return services[hostname] || 'Desconocido'; // Retorna el nombre del servicio o 'Desconocido'
        }

        async function deleteMovie(id) {
            const confirmDelete = confirm('¿Estás seguro de que deseas eliminar esta película?');
            if (confirmDelete) {
                try {
                    const response = await fetch(`http://localhost:8080/api/peliculas/${id}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        alert('Película eliminada con éxito');
                        window.location.href = 'index.html'; // Redirigir a la página principal
                    } else {
                        alert('Error al eliminar la película. Inténtalo de nuevo más tarde.');
                    }
                } catch (error) {
                    console.error('Error al eliminar la película:', error);
                }
            }
        }
    </script>
</body>
</html>